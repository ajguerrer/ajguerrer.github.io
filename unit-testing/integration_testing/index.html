<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.65.3" />
    <meta name="theme-color" content="#85ad85">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="translucent">
    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Integration Testing :: Notebook</title>

    
    <link href="/css/nucleus.css?1583098026" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1583098026" rel="stylesheet">
    <link href="/css/hybrid.css?1583098026" rel="stylesheet">
    <link href="/css/featherlight.min.css?1583098026" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1583098026" rel="stylesheet">
    <link href="/css/auto-complete.css?1583098026" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1583098026" rel="stylesheet">
    <link href="/css/theme.css?1583098026" rel="stylesheet">
    <link href="/css/hugo-theme.css?1583098026" rel="stylesheet">
    
      <link href="/css/theme-gruvbox.css?1583098026" rel="stylesheet">
    

    <script src="/js/jquery-3.3.1.min.js?1583098026"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    <link href="/css/gruvbox-dark.css" rel="stylesheet" />
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body class="" data-url="/unit-testing/integration_testing/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <div class="logo">
  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 90.000000 183.000000"
    preserveAspectRatio="xMidYMid meet">
    <g transform="translate(0.000000,183.000000) scale(0.100000,-0.100000)" stroke="none">
      <path d="M437 1690 c-4 -30 -7 -131 -8 -225 -2 -224 -2 -224 -62 -242 -67 -19
    -147 -97 -147 -141 0 -18 2 -32 4 -32 2 0 15 17 29 38 27 41 104 96 150 107
    l28 7 -3 -107 -3 -108 -30 -11 c-54 -19 -106 -57 -103 -75 2 -9 35 -32 74 -51
    l72 -35 7 -68 c8 -84 17 -80 19 8 l1 66 58 24 c32 13 67 31 78 41 17 15 18 19
    4 34 -8 9 -42 29 -75 45 l-60 29 0 101 c0 56 3 104 6 107 7 8 100 -29 134 -53
    14 -10 41 -40 60 -68 31 -45 50 -62 50 -46 0 17 -43 85 -72 114 -33 34 -119
    81 -149 81 -19 0 -24 43 -35 309 -8 182 -17 235 -27 151z m-11 -806 l-7 -33
    -40 18 c-68 31 -68 38 -8 66 l54 25 3 -21 c2 -12 1 -36 -2 -55z m101 50 c24
    -9 43 -21 43 -25 0 -12 -40 -36 -72 -44 -27 -7 -28 -6 -28 39 0 25 3 46 7 46
    4 0 27 -7 50 -16z" />
      <path d="M92 893 c14 -133 101 -250 231 -311 37 -18 74 -32 81 -32 8 0 17 -4
20 -8 3 -5 6 -109 7 -231 0 -123 5 -219 9 -214 19 20 30 125 30 278 l0 165 28
6 c75 17 98 25 133 50 57 39 108 107 139 183 32 77 49 157 31 147 -6 -4 -11
-12 -11 -17 0 -6 -16 -49 -36 -95 -31 -72 -46 -93 -98 -138 -69 -60 -120 -81
-176 -72 -22 3 -41 2 -45 -4 -15 -25 -86 1 -173 63 -51 37 -127 151 -148 224
-9 29 -18 53 -21 53 -3 0 -3 -21 -1 -47z" />
    </g>
  </svg>
  <p>Notebook</p>
</div>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1583098026"></script>
<script type="text/javascript" src="/js/auto-complete.js?1583098026"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/ajguerrer.github.io\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1583098026"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/google-testing-blog/" title="Google Testing Blog" class="dd-item 
        
        
        
        ">
      <a href="/google-testing-blog/">
          Google Testing Blog
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/google-testing-blog/general/" title="General Notes" class="dd-item ">
        <a href="/google-testing-blog/general/">
        General Notes
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/google-testing-blog/testable_code/" title="Guide to Writing Testable Code" class="dd-item ">
        <a href="/google-testing-blog/testable_code/">
        Guide to Writing Testable Code
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/google-testing-blog/whittaker/" title="James Whittaker" class="dd-item ">
        <a href="/google-testing-blog/whittaker/">
        James Whittaker
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/google-testing-blog/tott/" title="Testing on the Toilet" class="dd-item ">
        <a href="/google-testing-blog/tott/">
        Testing on the Toilet
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/unit-testing/" title="Unit Testing Principles, Practices, and Patterns" class="dd-item 
        parent
        
        
        ">
      <a href="/unit-testing/">
          Unit Testing Principles, Practices, and Patterns
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/unit-testing/bigger_picture/" title="The Bigger Picture" class="dd-item ">
        <a href="/unit-testing/bigger_picture/">
        The Bigger Picture
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/unit-testing/making_tests_work/" title="Making your Tests Work for You" class="dd-item ">
        <a href="/unit-testing/making_tests_work/">
        Making your Tests Work for You
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/unit-testing/integration_testing/" title="Integration Testing" class="dd-item active">
        <a href="/unit-testing/integration_testing/">
        Integration Testing
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/unit-testing/antipatterns/" title="Unit Testing Anti-Patterns" class="dd-item ">
        <a href="/unit-testing/antipatterns/">
        Unit Testing Anti-Patterns
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Notebook</a> > <a href='/unit-testing/'>Unit Testing Principles, Practices, and Patterns</a> > Integration Testing
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#role-of-integration-tests">Role of Integration Tests</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#mocking-best-practices">Mocking Best Practices</a></li>
    <li><a href="#testing-the-database">Testing the Database</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Integration Testing
            </h1>
          

        



<h2 id="role-of-integration-tests">Role of Integration Tests</h2>
<p>Integration tests verify:</p>
<ul>
<li>Interactions with external dependencies.</li>
<li>Edge cases unsuitable for a unit test.</li>
</ul>
<p>Each integration test should choose a happy path that exercises as many shared external dependencies
as possible while staying within a single use case. If a single integration test doesn&rsquo;t cover all
shared external dependencies, write more until all external dependencies are covered.</p>

<div class="notices tip" ><p>To keep maintenance costs low, check as many edge cases as possible with unit tests before resorting
to an integration test.</p>
</div>


<div class="notices tip" ><p>Edge cases that immediately stop the current operation without changing state adhere to the
<em>Fail Fast principle</em> and don&rsquo;t require an integration test.</p>
</div>

<p>While unit tests are great for testing domain logic, integration tests are great for testing
controllers.</p>
<p><img src="/images/test_matrix.png" alt="Test matrix"></p>
<h4 id="interfaces">Interfaces</h4>
<p>Genuine abstractions are <em>discovered</em>, not <em>invented</em>. For an interface to be genuine, it must have
at least two implementations. Otherwise, the the added cognitive complexity isn&rsquo;t worth it.</p>
<p>Interfaces enable mocking. Write an interface to mock shared external dependencies.
However, not all external dependencies need an interface. Private external dependencies
don&rsquo;t need mocks and therefore don&rsquo;t benefit from an interface, unless there is a need to be to swap
them with another implementation in production.</p>
<h4 id="layering">Layering</h4>
<p>Adding layers of indirection where they are not appropriate makes code hard to reason with. Aim
to have as few layers as possible. Most applications only need three layers: Domain, Controller, and
Infrastructure. The Domain and Controller Layers are already familiar. The Infrastructure Layer
provides utility libraries such as logging and networking.</p>
<p><img src="/images/layering.png" alt="Layering"></p>
<h4 id="logging">Logging</h4>
<p>Logging falls under two categories:</p>
<ul>
<li><strong>Support logging</strong> - messages are intended to be consumed by support staff and system admins;
observable behavior.</li>
<li><strong>Diagnostic logging</strong> - messages are intended to be consumed by developers; implementation
detail.</li>
</ul>
<p>Since <em>Support</em> logging is observable behavior, it is worth the testing effort. <em>Diagnostic</em>
logging, however, is an implementation detail and isn&rsquo;t worth testing.</p>

<div class="notices note" ><p>The Domain layer should not have dependencies, including loggers. The Controller layer may inject a
logger, or the Domain layer may emit a log event.</p>
</div>

<p>Effective logging maximizes the signal to noise ratio. <em>Support</em> logging cannot be controlled
because its a business requirement, but <em>Diagnostic</em> logging can. Minimize diagnostic logging
in the Domain layer, only adding it for debugging and then subsequently removing it once finished.</p>
<h2 id="mocking-best-practices">Mocking Best Practices</h2>
<ul>
<li><strong>Mocks are for integration tests only</strong> - Mentioned in
<a href="/unit-testing/making_tests_work/#hexagonal-architecture">Hexagonal Architecture</a>, only shared
external dependencies should be mocked. Unit tests target the Domain layer which shouldn&rsquo;t
communicate with external dependencies.</li>
<li><strong>Never mock private external dependencies</strong> - When a private external dependency is too
difficult or prohibitive to setup, don&rsquo;t try to mock it out. If that dependency cannot be tested
as-is, it defeats the point of integration testing and should not be tested at all.</li>
<li><strong>Mock the furthest edges of the system</strong> - Mock the type that directly communicates with a
shared dependency, not the wrapper. Verify the message sent to a shared dependency, not a call
to a class you wrote. Doing so maximizes resistance against regressions.</li>
<li><strong>Use as many mocks as necessary per test</strong> -  One mock per test is a common misconception. It&rsquo;s
irrelevant how many mocks it takes to verify one unit of behavior. The number of mocks depends
solely on the number of shared external dependencies participating in the unit of behavior.</li>
<li><strong>Verify the absence of unexpected messages too</strong> - It is not enough to verify your system is
sending the correct messages to shared external dependencies, unexpected messages are a
source of bugs too.</li>
<li><strong>Mock only the types you own</strong> - If your using a third party library to communicate with a shared
external dependency, write a adapter for it and mock the adapter instead. Third-party
libraries have arcane inner workings, so it&rsquo;s futile to try to emulate their behavior.</li>
</ul>
<h2 id="testing-the-database">Testing the Database</h2>
<h4 id="setup">Setup</h4>
<p>Be able to build your database from a series of migration scripts checked into source control. This
includes tables, views, indexes, stored procedures, reference data and anything else critical to
run the database in production.</p>

<div class="notices note" ><p><em>Reference data</em> is data that is necessary for the application to run, but isn&rsquo;t actively modified
by the application.</p>
</div>

<p>Migration scripts should be used in both testing and production. Once committed to source control,
don&rsquo;t modify them. Make a new migration script instead of fixing the old one, unless fixing the old
one prevents data loss.</p>
<h4 id="transactions">Transactions</h4>
<p>Transactions are capable of updating sets of data within the same business operation atomically.
When transactions are involved, applications need to make two separate types of decisions:</p>
<ol>
<li>Which data gets updated to what?</li>
<li>Should a set of updates be kept or rolled back?</li>
</ol>
<p>These decisions should be separated into two different responsibilities:</p>
<ul>
<li><strong>Repositories</strong> - Can access and modify database data; lifetime lasts the duration of the query.</li>
<li><strong>Transactions</strong> - Commits or rolls back a set of updates in full; lifetime lasts the duration of
the business operation.</li>
</ul>

<div class="notices note" ><p>Non-relational databases lack transactions. Instead, updates to the document are atomic. Related
data should be placed in the same document so that updates don&rsquo;t span more than one document.</p>
</div>

<p>To replicate the production environment as closely as possible, integration tests should wrap the
<em>act</em> section in a separate transaction from the <em>arrange</em> and <em>assert</em> sections.</p>
<h4 id="cleanup">Cleanup</h4>
<p>There are many ways to cleanup a database between tests:</p>
<ul>
<li><strong>Restore a backup database before each test</strong> - Works, but is slow.</li>
<li><strong>Cleanup data at the end of the test</strong> - Might be skipped when test fails.</li>
<li><strong>Wrap each test in a transaction and then don&rsquo;t commit</strong> - Makes behavior between production and
testing inconsistent.</li>
<li><strong>Cleanup data at the beginning of the test</strong> - Fast, consistent, and won&rsquo;t get skipped.</li>
</ul>
<h4 id="best-practices">Best Practices</h4>
<ul>
<li><strong>Avoid in-memory databases</strong> - Behavior between production and testing should be consistent.</li>
<li><strong>Reuse code in test sections</strong> - <em>Arrange</em> with factory or builder pattern, <em>act</em> with decorator
pattern, and <em>assert</em> with handmade mocks (a.k.a. Spys).</li>
<li><strong>Skip trivial database read tests</strong> - Writes are always important because the alter the state of
the database. Reads that important or complex should be tested; disregard the rest.</li>
<li><strong>Don&rsquo;t test repositories directly</strong> - Repositories are a controller, so they shouldn&rsquo;t be
complex. The point of an integration test is to cover shared, external dependencies, not
controllers.</li>
</ul>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/unit-testing/making_tests_work/" title="Making your Tests Work for You"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/unit-testing/antipatterns/" title="Unit Testing Anti-Patterns" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1583098026"></script>
    <script src="/js/perfect-scrollbar.min.js?1583098026"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1583098026"></script>
    <script src="/js/jquery.sticky.js?1583098026"></script>
    <script src="/js/featherlight.min.js?1583098026"></script>
    <script src="/js/highlight.pack.js?1583098026"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1583098026"></script>
    <script src="/js/learn.js?1583098026"></script>
    <script src="/js/hugo-learn.js?1583098026"></script>

    <link href="/mermaid/mermaid.css?1583098026" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1583098026"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>


<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.64.0" />
    <meta name="theme-color" content="#85ad85">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="translucent">
    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Guide to Writing Testable Code :: Notebook</title>

    
    <link href="/css/nucleus.css?1582391604" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1582391604" rel="stylesheet">
    <link href="/css/hybrid.css?1582391604" rel="stylesheet">
    <link href="/css/featherlight.min.css?1582391604" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1582391604" rel="stylesheet">
    <link href="/css/auto-complete.css?1582391604" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1582391604" rel="stylesheet">
    <link href="/css/theme.css?1582391604" rel="stylesheet">
    <link href="/css/hugo-theme.css?1582391604" rel="stylesheet">
    
      <link href="/css/theme-gruvbox.css?1582391604" rel="stylesheet">
    

    <script src="/js/jquery-3.3.1.min.js?1582391604"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    <link href="/css/gruvbox-dark.css" rel="stylesheet" />
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body class="" data-url="/google-testing-blog/testable_code/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <div class="logo">
  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 90.000000 183.000000"
    preserveAspectRatio="xMidYMid meet">
    <g transform="translate(0.000000,183.000000) scale(0.100000,-0.100000)" stroke="none">
      <path d="M437 1690 c-4 -30 -7 -131 -8 -225 -2 -224 -2 -224 -62 -242 -67 -19
    -147 -97 -147 -141 0 -18 2 -32 4 -32 2 0 15 17 29 38 27 41 104 96 150 107
    l28 7 -3 -107 -3 -108 -30 -11 c-54 -19 -106 -57 -103 -75 2 -9 35 -32 74 -51
    l72 -35 7 -68 c8 -84 17 -80 19 8 l1 66 58 24 c32 13 67 31 78 41 17 15 18 19
    4 34 -8 9 -42 29 -75 45 l-60 29 0 101 c0 56 3 104 6 107 7 8 100 -29 134 -53
    14 -10 41 -40 60 -68 31 -45 50 -62 50 -46 0 17 -43 85 -72 114 -33 34 -119
    81 -149 81 -19 0 -24 43 -35 309 -8 182 -17 235 -27 151z m-11 -806 l-7 -33
    -40 18 c-68 31 -68 38 -8 66 l54 25 3 -21 c2 -12 1 -36 -2 -55z m101 50 c24
    -9 43 -21 43 -25 0 -12 -40 -36 -72 -44 -27 -7 -28 -6 -28 39 0 25 3 46 7 46
    4 0 27 -7 50 -16z" />
      <path d="M92 893 c14 -133 101 -250 231 -311 37 -18 74 -32 81 -32 8 0 17 -4
20 -8 3 -5 6 -109 7 -231 0 -123 5 -219 9 -214 19 20 30 125 30 278 l0 165 28
6 c75 17 98 25 133 50 57 39 108 107 139 183 32 77 49 157 31 147 -6 -4 -11
-12 -11 -17 0 -6 -16 -49 -36 -95 -31 -72 -46 -93 -98 -138 -69 -60 -120 -81
-176 -72 -22 3 -41 2 -45 -4 -15 -25 -86 1 -173 63 -51 37 -127 151 -148 224
-9 29 -18 53 -21 53 -3 0 -3 -21 -1 -47z" />
    </g>
  </svg>
  <p>Notebook</p>
</div>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1582391604"></script>
<script type="text/javascript" src="/js/auto-complete.js?1582391604"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/ajguerrer.github.io\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1582391604"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/google-testing-blog/" title="Google Testing Blog" class="dd-item 
        parent
        
        
        ">
      <a href="/google-testing-blog/">
          Google Testing Blog
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/google-testing-blog/general/" title="General Notes" class="dd-item ">
        <a href="/google-testing-blog/general/">
        General Notes
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/google-testing-blog/testable_code/" title="Guide to Writing Testable Code" class="dd-item active">
        <a href="/google-testing-blog/testable_code/">
        Guide to Writing Testable Code
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/google-testing-blog/whittaker/" title="James Whittaker" class="dd-item ">
        <a href="/google-testing-blog/whittaker/">
        James Whittaker
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/google-testing-blog/tott/" title="Testing on the Toilet" class="dd-item ">
        <a href="/google-testing-blog/tott/">
        Testing on the Toilet
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/unit-testing/" title="Unit Testing Principles, Practices, and Patterns" class="dd-item 
        
        
        
        ">
      <a href="/unit-testing/">
          Unit Testing Principles, Practices, and Patterns
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/unit-testing/bigger_picture/" title="The Bigger Picture" class="dd-item ">
        <a href="/unit-testing/bigger_picture/">
        The Bigger Picture
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/unit-testing/making_tests_work/" title="Making your Tests Work for You" class="dd-item ">
        <a href="/unit-testing/making_tests_work/">
        Making your Tests Work for You
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/unit-testing/integration_testing/" title="Integration Testing" class="dd-item ">
        <a href="/unit-testing/integration_testing/">
        Integration Testing
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/unit-testing/antipatterns/" title="Unit Testing Anti-Patterns" class="dd-item ">
        <a href="/unit-testing/antipatterns/">
        Unit Testing Anti-Patterns
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Notebook</a> > <a href='/google-testing-blog/'>Google Testing Blog</a> > Guide to Writing Testable Code
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#dependency-injection">Dependency Injection</a>
      <ul>
        <li><a href="#fixing-violations">Fixing violations</a></li>
      </ul>
    </li>
    <li><a href="#law-of-demeter">Law of Demeter</a>
      <ul>
        <li><a href="#fixing-violations-1">Fixing violations</a></li>
      </ul>
    </li>
    <li><a href="#global-state">Global State</a>
      <ul>
        <li><a href="#fixing-violations-2">Fixing violations</a></li>
      </ul>
    </li>
    <li><a href="#single-responsibility-principle">Single Responsibility Principle</a>
      <ul>
        <li><a href="#fixing-violations-3">Fixing violations</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Guide to Writing Testable Code
            </h1>
          

        



<div style="text-align:center">
    <h3>Miško Hevery</h3>
</div>
<p>You may find Miško&rsquo;s original guide <a href="http://misko.hevery.com/code-reviewers-guide/">here</a>.</p>
<h2 id="dependency-injection">Dependency Injection</h2>
<p>A testable class is one that can be constructed in isolation or with test double collaborators. Once
constructed, they have all the dependencies they need. This is known as Dependency Injection.</p>
<p>Dependencies do not need to be concrete classes. Abstract classes allow testers to leverage
inheritance for creating test double collaborators. This is the primary tool in a testers toolkit
and the primary benefit Dependency Injection brings.</p>
<h3 id="fixing-violations">Fixing violations</h3>
<p>Below are some examples of constructor flaws and how they can be fixed with Dependency Injection.</p>
<h4 id="static-method-calls">Static method calls</h4>

<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">AccountView</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
  <span class="n">AccountView</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="n">user_</span> <span class="o">=</span> <span class="n">RPCClient</span><span class="o">:</span><span class="o">:</span><span class="n">GetInstance</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="n">GetUser</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
  <span class="n">User</span> <span class="n">user_</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">AccountViewTest</span><span class="p">,</span> <span class="n">SlowAndFlakyTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Unit test is slow and requires working network connection.
</span><span class="c1"></span>  <span class="n">AccountView</span> <span class="n">view</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">AccountView</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">AccountView</span><span class="p">(</span><span class="k">const</span> <span class="n">User</span><span class="o">&amp;</span> <span class="n">user</span><span class="p">)</span><span class="o">:</span> <span class="n">user_</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
  <span class="n">User</span> <span class="n">user_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">AccountViewTest</span><span class="p">,</span> <span class="n">FastAndReliableTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// User does not need to be retrieved over the network.
</span><span class="c1"></span>  <span class="n">MockUser</span> <span class="n">user</span><span class="p">;</span>
  <span class="n">AccountView</span> <span class="nf">view</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="conditional-logic">Conditional logic</h4>

<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">Car</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">Car</span><span class="p">(</span><span class="n">CarType</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nl">kCoupe</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">engine_</span> <span class="o">=</span> <span class="n">FastEngine</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
        <span class="n">tires_</span> <span class="o">=</span> <span class="n">SmoothTires</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="nl">kTruck</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">engine_</span> <span class="o">=</span> <span class="n">StrongEngine</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
        <span class="n">tires_</span> <span class="o">=</span> <span class="n">KnobbyTires</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">Engine</span> <span class="n">engine_</span><span class="p">;</span>
  <span class="n">Tires</span> <span class="n">tires_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">CarTest</span><span class="p">,</span> <span class="n">HardToTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Want a car with fake engine and tires but can only make real ones.
</span><span class="c1"></span>  <span class="n">Car</span> <span class="nf">car</span><span class="p">(</span><span class="n">kCoupe</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">Car</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">Car</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Engine</span><span class="o">&gt;</span> <span class="n">engine</span><span class="p">,</span> <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Tires</span><span class="o">&gt;</span> <span class="n">tires</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">engine_</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">move</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span><span class="p">)</span><span class="p">,</span> <span class="n">tires_</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">move</span><span class="p">(</span><span class="n">tires</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Engine</span><span class="o">&gt;</span> <span class="n">engine_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Tires</span><span class="o">&gt;</span> <span class="n">tires_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">CarTest</span><span class="p">,</span> <span class="n">EasyToTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Car is fully configurable
</span><span class="c1"></span>  <span class="n">Car</span> <span class="nf">car</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">FakeEngine</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">FakeTires</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="constructing-dependencies">Constructing dependencies</h4>
<p>
<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">House</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
  <span class="n">House</span><span class="p">(</span><span class="p">)</span> <span class="o">:</span> <span class="n">kitchen_</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="n">bedroom_</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span>
  <span class="k">private</span><span class="o">:</span>
  <span class="n">Kitchen</span> <span class="n">kitchen_</span><span class="p">;</span>
  <span class="n">Bedroom</span> <span class="n">bedroom_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">HouseTest</span><span class="p">,</span> <span class="n">HardToTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// house is stuck with Kitchen and Bedroom objects
</span><span class="c1"></span>  <span class="n">House</span> <span class="n">house</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">House</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
  <span class="n">House</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Kitchen</span><span class="o">&gt;</span> <span class="n">kitchen</span><span class="p">,</span> <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Bedroom</span><span class="o">&gt;</span> <span class="n">bedroom</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">kitchen_</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">move</span><span class="p">(</span><span class="n">kitchen</span><span class="p">)</span><span class="p">)</span><span class="p">,</span> <span class="n">bedroom_</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">move</span><span class="p">(</span><span class="n">bedroom</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span>
  <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Kitchen</span><span class="o">&gt;</span> <span class="n">kitchen_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Bedroom</span><span class="o">&gt;</span> <span class="n">bedroom_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">HouseTest</span><span class="p">,</span> <span class="n">EasyToTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// house uses lightweight test doubles
</span><span class="c1"></span>  <span class="n">House</span> <span class="nf">house</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">MockKitchen</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
              <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">MockBedroom</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</p>
<h4 id="partial-construction">Partial construction</h4>
<p>
<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">VisualVoicemail</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
  <span class="c1">// Constructs a partially initialized VisualVoicemail.
</span><span class="c1"></span>  <span class="c1">// Don&#39;t forget to call Initialize in production, or SetCalls in test!
</span><span class="c1"></span>  <span class="k">explicit</span> <span class="n">VisualVoicemail</span><span class="p">(</span><span class="k">const</span> <span class="n">User</span><span class="o">&amp;</span> <span class="n">user</span><span class="p">)</span> <span class="o">:</span> <span class="n">user_</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>

  <span class="kt">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">calls_</span> <span class="o">=</span> <span class="n">Server</span><span class="o">:</span><span class="o">:</span><span class="n">GetCallsFor</span><span class="p">(</span><span class="n">user_</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
  <span class="c1">// Hack to allow test access to private methods.
</span><span class="c1"></span>  <span class="c1">// Making this function public is not a better idea.
</span><span class="c1"></span>  <span class="k">friend</span> <span class="k">class</span> <span class="nc">VisualVoicemailTest_BrittleDesign_Test</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">SetCalls</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Call</span><span class="o">&gt;</span><span class="o">&amp;</span> <span class="n">calls</span><span class="p">)</span> <span class="p">{</span> <span class="n">calls_</span> <span class="o">=</span> <span class="n">calls</span><span class="p">;</span> <span class="p">}</span>

  <span class="n">User</span> <span class="n">user_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Call</span><span class="o">&gt;</span> <span class="n">calls_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">VisualVoicemailTest</span><span class="p">,</span> <span class="n">BrittleTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">DummyUser</span> <span class="n">user</span><span class="p">;</span>
  <span class="n">VisualVoicemail</span> <span class="nf">voicemail</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="p">;</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Call</span><span class="o">&gt;</span> <span class="n">calls</span> <span class="o">=</span> <span class="n">BuildListOfTestCalls</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">voicemail</span><span class="p">.</span><span class="n">SetCalls</span><span class="p">(</span><span class="n">calls</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">VisualVoicemail</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">VisualVoicemail</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Call</span><span class="o">&gt;</span><span class="o">&amp;</span> <span class="n">calls</span><span class="p">)</span> <span class="o">:</span> <span class="n">calls_</span><span class="p">(</span><span class="n">calls</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Call</span><span class="o">&gt;</span> <span class="n">calls_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">VisualVoicemailTest</span><span class="p">,</span> <span class="n">FlexibleTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">VisualVoicemail</span> <span class="nf">voicemail</span><span class="p">(</span><span class="n">BuildListOfTestCalls</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</p>
<h2 id="law-of-demeter">Law of Demeter</h2>
<p>A class becomes difficult to test if it gets its dependencies from anywhere besides it&rsquo;s interface.
For example, a class may get a dependency by asking one of it dependencies, breaking the Law of Demeter.</p>
<p>Violations of the Law of Demeter are a sign of bad Dependency Injection, for passing in the wrong
dependency, and bad encapsulation, for exposing secondary dependencies in the first place.</p>
<h3 id="fixing-violations-1">Fixing violations</h3>
<p>Below are examples of Law of Demeter violations and how they can be fixed with accurate interfaces
and encapsulation.</p>
<h4 id="indirect-dependencies">Indirect dependencies</h4>

<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">SalesTaxCalculator</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">SalesTaxCalculator</span><span class="p">(</span><span class="k">const</span> <span class="n">TaxTable</span><span class="o">&amp;</span> <span class="n">taxTable</span><span class="p">)</span> <span class="o">:</span> <span class="n">taxTable_</span><span class="p">(</span><span class="n">taxTable</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>

  <span class="kt">float</span> <span class="nf">ComputeSalesTax</span><span class="p">(</span><span class="k">const</span> <span class="n">User</span><span class="o">&amp;</span> <span class="n">user</span><span class="p">,</span> <span class="k">const</span> <span class="n">Invoice</span><span class="o">&amp;</span> <span class="n">invoice</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Get the correct dependencies first.
</span><span class="c1"></span>    <span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">GetAddress</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">invoice</span><span class="p">.</span><span class="n">GetSubTotal</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="c1">// Then, do the calculation.
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">taxTable_</span><span class="p">.</span><span class="n">GetTaxRate</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>

 <span class="k">public</span><span class="o">:</span>
  <span class="n">TaxTable</span> <span class="n">taxTable_</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">SalesTaxCalculatorTest</span><span class="p">,</span> <span class="n">ComplexTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">SalesTaxCalculator</span> <span class="nf">calc</span><span class="p">(</span><span class="n">TaxTable</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">User</span> <span class="nf">user</span><span class="p">(</span><span class="n">Address</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">1600 Amphitheater Parkway...</span><span class="s">&#34;</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">Invoice</span> <span class="nf">invoice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ProductX</span><span class="p">(</span><span class="mf">95.00</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mf">0.09</span><span class="p">,</span> <span class="n">calc</span><span class="p">.</span><span class="n">ComputeSalesTax</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">invoice</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">SalesTaxCalculator</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">SalesTaxCalculator</span><span class="p">(</span><span class="k">const</span> <span class="n">TaxTable</span><span class="o">&amp;</span> <span class="n">taxTable</span><span class="p">)</span> <span class="o">:</span> <span class="n">taxTable_</span><span class="p">(</span><span class="n">taxTable</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>

  <span class="kt">float</span> <span class="nf">ComputeSalesTax</span><span class="p">(</span><span class="k">const</span> <span class="n">Address</span><span class="o">&amp;</span> <span class="n">address</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Already have the correct dependencies; do the calculation.
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">taxTable_</span><span class="p">.</span><span class="n">GetTaxRate</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>

 <span class="k">public</span><span class="o">:</span>
  <span class="n">TaxTable</span> <span class="n">taxTable_</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">SalesTaxCalculatorTest</span><span class="p">,</span> <span class="n">StraightforwardTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">SalesTaxCalculator</span> <span class="nf">calc</span><span class="p">(</span><span class="n">TaxTable</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">Address</span> <span class="nf">address</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">1600 Amphitheater Parkway...</span><span class="s">&#34;</span><span class="p">)</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mf">0.09</span><span class="p">,</span> <span class="n">calc</span><span class="p">.</span><span class="n">ComputeSalesTax</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mf">95.00</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="overusing-member-access-operator">Overusing member access operator</h4>

<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">LoginPage</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">LoginPage</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">RPCClient</span><span class="o">&gt;</span> <span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="n">HttpRequest</span><span class="o">&amp;</span> <span class="n">request</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">client_</span><span class="p">(</span><span class="n">client</span><span class="p">)</span><span class="p">,</span> <span class="n">request_</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>

  <span class="kt">bool</span> <span class="nf">Login</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Even using member access access operator once is one more time than it
</span><span class="c1"></span>    <span class="c1">// needs to be.
</span><span class="c1"></span>    <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">string</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">request_</span><span class="p">.</span><span class="n">GetCookie</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">g</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
    <span class="c1">// Using a member access operator twice in one statement is right out!
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">client_</span><span class="p">.</span><span class="n">GetAuthenticator</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="n">Authenticate</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">RPCClient</span><span class="o">&gt;</span> <span class="n">client_</span><span class="p">;</span>
  <span class="n">HttpRequest</span> <span class="n">request_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">LoginPageTest</span><span class="p">,</span> <span class="n">ComplexBrittleTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MockRPCClient</span> <span class="nf">mock_client</span><span class="p">(</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">FakeAuthenticator</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;</span> <span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="n">Cookie</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">g</span><span class="s">&#34;</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">xyz123</span><span class="s">&#34;</span><span class="p">)</span><span class="p">}</span><span class="p">;</span>
  <span class="n">MockHttpRequest</span> <span class="nf">mock_request</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span><span class="p">;</span>
  <span class="n">LoginPage</span> <span class="nf">page</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="p">;</span>

  <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="n">mock_client</span><span class="p">,</span> <span class="n">GetAuthenticator</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="n">mock_request</span><span class="p">,</span> <span class="n">GetCookie</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">g</span><span class="s">&#34;</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

  <span class="n">EXPECT_TRUE</span><span class="p">(</span><span class="n">page</span><span class="p">.</span><span class="n">Login</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">LoginPage</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">LoginPage</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Authenticator</span><span class="o">&gt;</span> <span class="n">authenticator</span><span class="p">,</span> <span class="k">const</span> <span class="n">Cookie</span><span class="o">&amp;</span> <span class="n">cookie</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">authenticator_</span><span class="p">(</span><span class="n">authenticator</span><span class="p">)</span><span class="p">,</span> <span class="n">cookie_</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>

  <span class="kt">bool</span> <span class="nf">Login</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">authenticator_</span><span class="p">.</span><span class="n">Authenticate</span><span class="p">(</span><span class="n">cookie_</span><span class="p">)</span><span class="p">;</span> <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Authenticator</span><span class="o">&gt;</span> <span class="n">authenticator_</span><span class="p">;</span>
  <span class="n">Cookie</span> <span class="n">cookie_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">LoginPageTest</span><span class="p">,</span> <span class="n">SimpleFlexibleTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">LoginPage</span> <span class="nf">page</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">FakeAuthenticator</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="n">Cookie</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">g</span><span class="s">&#34;</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">xyz123</span><span class="s">&#34;</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">EXPECT_TRUE</span><span class="p">(</span><span class="n">page</span><span class="p">.</span><span class="n">Login</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="exposing-dependencies">Exposing dependencies</h4>

<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">UpdateBug</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">UpdateBug</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">DatabaseInterface</span><span class="o">&gt;</span> <span class="n">db</span><span class="p">)</span> <span class="o">:</span> <span class="n">db_</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>
  <span class="kt">void</span> <span class="nf">Execute</span><span class="p">(</span><span class="k">const</span> <span class="n">Bug</span><span class="o">&amp;</span> <span class="n">bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Impose internal lock management on client.
</span><span class="c1"></span>    <span class="n">db_</span><span class="o">-</span><span class="o">&gt;</span><span class="n">GetLock</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="n">Lock</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="n">db_</span><span class="o">-</span><span class="o">&gt;</span><span class="n">Save</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span><span class="p">;</span>
    <span class="n">db_</span><span class="o">-</span><span class="o">&gt;</span><span class="n">GetLock</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="n">Unlock</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">DatabaseInterface</span><span class="o">&gt;</span> <span class="n">db_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="c1">// This test shouldn&#39;t be needed, but we must enforce Lock/Unlock is called
</span><span class="c1"></span><span class="c1">// around Save.
</span><span class="c1"></span><span class="n">TEST</span><span class="p">(</span><span class="n">UpdateBugTest</span><span class="p">,</span> <span class="n">HardToTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MockLock</span> <span class="n">mock_lock</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">mock_db</span> <span class="o">=</span> <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MockDatabase</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">Bug</span> <span class="nf">bug</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">description</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">UpdateBug</span> <span class="nf">updateBug</span><span class="p">(</span><span class="n">mock_db</span><span class="p">)</span><span class="p">;</span>

  <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="o">*</span><span class="n">mock_db</span><span class="p">,</span> <span class="n">GetLock</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="n">WillRepeatedly</span><span class="p">(</span><span class="n">ReturnRef</span><span class="p">(</span><span class="n">mock_lock</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="p">{</span>
    <span class="n">InSequence</span> <span class="n">dummy</span><span class="p">;</span>
    <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="n">mock_lock</span><span class="p">,</span> <span class="n">Lock</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
    <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="o">*</span><span class="n">mock_db</span><span class="p">,</span> <span class="n">Save</span><span class="p">(</span><span class="n">Ref</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
    <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="n">mock_lock</span><span class="p">,</span> <span class="n">Unlock</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">updateBug</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">UpdateBug</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">UpdateBug</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">DatabaseInterface</span><span class="o">&gt;</span> <span class="n">db</span><span class="p">)</span> <span class="o">:</span> <span class="n">db_</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>
  <span class="kt">void</span> <span class="nf">Execute</span><span class="p">(</span><span class="k">const</span> <span class="n">Bug</span><span class="o">&amp;</span> <span class="n">bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Save calls Lock/Unlock internally
</span><span class="c1"></span>    <span class="n">db_</span><span class="o">-</span><span class="o">&gt;</span><span class="n">Save</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">DatabaseInterface</span><span class="o">&gt;</span> <span class="n">db_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="c1">// Go strait to testing state. No need for mock test since locking interaction
</span><span class="c1"></span><span class="c1">// is encapsulated in the database.
</span><span class="c1"></span><span class="n">TEST</span><span class="p">(</span><span class="n">UpdateBugTest</span><span class="p">,</span> <span class="n">EasyTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">db</span> <span class="o">=</span> <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">FakeDatabase</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">UpdateBug</span> <span class="nf">updateBug</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">Bug</span> <span class="nf">bug</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">description</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">updateBug</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">bug</span><span class="p">)</span><span class="p">;</span>

  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">bug</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">GetLastSaved</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="context-objects">Context Objects</h4>

<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">MembershipPlan</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span> <span class="k">public</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">ProcessOrder</span><span class="p">(</span><span class="n">UserContext</span><span class="o">&amp;</span> <span class="n">userContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userContext</span><span class="p">.</span><span class="n">GetUser</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="n">PlanLevel</span> <span class="n">level</span> <span class="o">=</span> <span class="n">userContext</span><span class="p">.</span><span class="n">GetLevel</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">userContext</span><span class="p">.</span><span class="n">GetOrder</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

    <span class="c1">// process...
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">MembershipPlanTest</span><span class="p">,</span> <span class="n">BrittleUnreadableTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MembershipPlan</span> <span class="n">plan</span><span class="p">;</span>
  <span class="n">UserContext</span> <span class="n">userContext</span><span class="p">;</span>
  <span class="n">userContext</span><span class="p">.</span><span class="n">SetUser</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">Kim</span><span class="s">&#34;</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">userContext</span><span class="p">.</span><span class="n">SetLevel</span><span class="p">(</span><span class="n">PlanLevel</span><span class="p">(</span><span class="mi">143</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">yearly</span><span class="s">&#34;</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">userContext</span><span class="p">.</span><span class="n">SetOrder</span><span class="p">(</span><span class="n">Order</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">SuperDeluxe</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="c1">// Hopefully this is all the setup the userContext needs to call ProcessOrder
</span><span class="c1"></span>  <span class="n">plan</span><span class="p">.</span><span class="n">ProcessOrder</span><span class="p">(</span><span class="n">userContext</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// Make assertions against userContext and plan...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">MembershipPlan</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span> <span class="k">public</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">ProcessOrder</span><span class="p">(</span><span class="n">User</span><span class="o">&amp;</span> <span class="n">user</span><span class="p">,</span> <span class="n">Order</span><span class="o">&amp;</span> <span class="n">order</span><span class="p">,</span> <span class="k">const</span> <span class="n">PlanLevel</span><span class="o">&amp;</span> <span class="n">level</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// process...
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">MembershipPlanTest</span><span class="p">,</span> <span class="n">FlexibleSimpleTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MembershipPlan</span> <span class="n">plan</span><span class="p">;</span>
  <span class="n">User</span> <span class="nf">user</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">Kim</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">Order</span> <span class="nf">order</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">SuperDeluxe</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">PlanLevel</span> <span class="nf">level</span><span class="p">(</span><span class="mi">143</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">yearly</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">plan</span><span class="p">.</span><span class="n">ProcessOrder</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// Make assertions against user, order and plan...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div></div>

<h2 id="global-state">Global State</h2>
<p>Global state is difficult to understand. Ideally, the interface of an object should fully describe
it&rsquo;s dependencies. Global state ruins this ideal because it can be used anywhere without warning.
Such flexibility may seem convenient to the original developer, but to others it&rsquo;s confusing.
Especially in large code bases, it can be difficult to realize that some global state exists and
reason about the circumstances in which it should or shouldn&rsquo;t be used.</p>
<p>Global state is the enemy of testing. It strongly couples itself to the code that uses it. Global
scope encourages widespread usage, further compounding coupling issues. Coupling to concrete types
makes it impossible to write test doubles and global state must be concrete because it uses the
<code>static</code> keyword.</p>
<h3 id="fixing-violations-2">Fixing violations</h3>
<p>Below are some examples of global state and how they can be fixed with Dependency Injection.
However, Dependency Injection alone is often not enough to fix <code>static</code> methods. For those, an
adapter called the repository pattern can help remove the
<a href="../tott/#defeat-static-cling">static cling</a>.</p>
<p>Note, the solutions to the examples should not feel good and require a lot of work. It is really
tough to test global state. The best solution is to never use it or refactor away from it
altogether.</p>
<h4 id="singletons">Singletons</h4>

<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">LoginService</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">static</span> <span class="n">LoginService</span><span class="o">&amp;</span> <span class="n">GetInstance</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">LoginService</span> <span class="n">instance</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AdminDashboard</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="kt">bool</span> <span class="n">IsAuthenticatedAdmin</span><span class="p">(</span><span class="k">const</span> <span class="n">User</span><span class="o">&amp;</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">LoginService</span><span class="o">:</span><span class="o">:</span><span class="n">GetInstance</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="n">IsAuthenticatedAdmin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span><span class="p">;</span>

<span class="n">TEST_F</span><span class="p">(</span><span class="n">AdminDashboardTest</span><span class="p">,</span> <span class="n">FlakeySlowAndBrittleTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Forced to use the real LoginService singleton.
</span><span class="c1"></span>  <span class="n">User</span> <span class="nf">user</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">username</span><span class="s">&#34;</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">password</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">ASSERT_TRUE</span><span class="p">(</span><span class="n">adminDashboard_</span><span class="p">.</span><span class="n">IsAuthenticatedAdmin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">LoginServiceRepository</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">LoginServiceRepository</span><span class="p">(</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="n">LoginService</span><span class="o">&amp;</span> <span class="n">GetInstance</span><span class="p">(</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AdminDashboard</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">AdminDashboard</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">LoginServiceRepository</span><span class="o">&gt;</span> <span class="n">loginService</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">loginService_</span><span class="p">(</span><span class="n">loginService</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>
  <span class="kt">bool</span> <span class="nf">IsAuthenticatedAdmin</span><span class="p">(</span><span class="k">const</span> <span class="n">User</span><span class="o">&amp;</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">loginService_</span><span class="o">-</span><span class="o">&gt;</span><span class="n">GetInstance</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="n">IsAuthenticatedAdmin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">LoginServiceRepository</span><span class="o">&gt;</span> <span class="n">loginService_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">AdminDashboardTest</span><span class="p">,</span> <span class="n">ReliableFastAndFlexibleTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Can now use test doubles for the LoginService singleton.
</span><span class="c1"></span>  <span class="n">AdminDashboard</span> <span class="nf">adminDashboard</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MockLoginService</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">User</span> <span class="nf">user</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">username</span><span class="s">&#34;</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">password</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">ASSERT_TRUE</span><span class="p">(</span><span class="n">adminDashboard</span><span class="p">.</span><span class="n">IsAuthenticatedAdmin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="flags">Flags</h4>

<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="kt">bool</span> <span class="n">kFlagUseRealBackend</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RpcClient</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">static</span> <span class="n">RpcClient</span><span class="o">&amp;</span> <span class="n">GetInstance</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">RpcClient</span> <span class="n">instance</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="nf">IsReal</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">backend_</span><span class="o">-</span><span class="o">&gt;</span><span class="n">IsReal</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">RpcClient</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kFlagUseRealBackend</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">backend_</span> <span class="o">=</span> <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">RealBackend</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">backend_</span> <span class="o">=</span> <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">DummyBackend</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">//...
</span><span class="c1"></span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Backend</span><span class="o">&gt;</span> <span class="n">backend_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="c1">// The 2nd test to run will fail if both tests are run together
</span><span class="c1"></span><span class="c1">// because the RpcClient is static.
</span><span class="c1"></span>
<span class="n">TEST</span><span class="p">(</span><span class="n">RpcClientTest</span><span class="p">,</span> <span class="n">SmallComplexAndFlakeyTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">kFlagUseRealBackend</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">RpcClient</span><span class="o">&amp;</span> <span class="n">client</span> <span class="o">=</span> <span class="n">RpcClient</span><span class="o">:</span><span class="o">:</span><span class="n">GetInstance</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">EXPECT_FALSE</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">IsReal</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">RpcClientTest</span><span class="p">,</span> <span class="n">LargeComplexAndFlakeyTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">kFlagUseRealBackend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">RpcClient</span><span class="o">&amp;</span> <span class="n">client</span> <span class="o">=</span> <span class="n">RpcClient</span><span class="o">:</span><span class="o">:</span><span class="n">GetInstance</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">EXPECT_TRUE</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">IsReal</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">RpcClient</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">RpcClient</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Backend</span><span class="o">&gt;</span> <span class="n">backend</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">backend_</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">move</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>

  <span class="kt">bool</span> <span class="nf">IsReal</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">backend_</span><span class="o">-</span><span class="o">&gt;</span><span class="n">IsReal</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Backend</span><span class="o">&gt;</span> <span class="n">backend_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="c1">// Now, both tests pass.
</span><span class="c1"></span>
<span class="n">TEST</span><span class="p">(</span><span class="n">RpcClientTest</span><span class="p">,</span> <span class="n">SmallSimpleAndReliableTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">RpcClient</span> <span class="nf">client</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">DummyBackend</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">EXPECT_FALSE</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">IsReal</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">RpcClientTest</span><span class="p">,</span> <span class="n">LargeSimpleAndReliableTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">RpcClient</span> <span class="nf">client</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">RealBackend</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">EXPECT_TRUE</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">IsReal</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="static-methods">Static methods</h4>

<div class="notices warning" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">TrainSchedule</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Schedule</span><span class="o">&gt;</span> <span class="n">FindNextTrain</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="c1">// Slow third party service
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TrackStatus</span><span class="o">:</span><span class="o">:</span><span class="n">IsClosed</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">schedule</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">TEST_F</span><span class="p">(</span><span class="n">TrainScheduleTest</span><span class="p">,</span> <span class="n">FlakeySlowAndBrittleTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Forces third party TrackStatus to get called
</span><span class="c1"></span>  <span class="n">ASSERT_NE</span><span class="p">(</span><span class="n">trainSchedule_</span><span class="p">.</span><span class="n">FindNextTrain</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>


<div class="notices tip" ><div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">TrackStatusRepository</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">TrackStatusRepository</span><span class="p">(</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">IsClosed</span><span class="p">(</span><span class="k">const</span> <span class="n">Track</span><span class="o">&amp;</span> <span class="n">track</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RealTrackStatusRepository</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TrackStatusRepository</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="c1">// ... Wrap each of the third party library&#39;s methods.
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="n">IsClosed</span><span class="p">(</span><span class="k">const</span> <span class="n">Track</span><span class="o">&amp;</span> <span class="n">track</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">TrackStatus</span><span class="o">:</span><span class="o">:</span><span class="n">IsClosed</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">TrainSchedule</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TrainSchedule</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">TrackStatusRepository</span><span class="o">&gt;</span> <span class="n">trackStatus</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">trackStatus_</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">move</span><span class="p">(</span><span class="n">trackStatus</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Schedule</span><span class="o">&gt;</span> <span class="n">FindNextTrain</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">trackStatus_</span><span class="o">-</span><span class="o">&gt;</span><span class="n">IsClosed</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">schedule</span><span class="p">;</span>
  <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">TrackStatusRepository</span><span class="o">&gt;</span> <span class="n">trackStatus_</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">TrainScheduleTest</span><span class="p">,</span> <span class="n">ReliableFastAndFlexibleTest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Now TrainSchedule can be tested in isolation.
</span><span class="c1"></span>  <span class="n">TrainSchedule</span> <span class="nf">trainSchedule</span><span class="p">(</span><span class="n">std</span><span class="o">:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">StubTrackStatusRepository</span><span class="o">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">ASSERT_NE</span><span class="p">(</span><span class="n">trainSchedule</span><span class="p">.</span><span class="n">FindNextTrain</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="single-responsibility-principle">Single Responsibility Principle</h2>
<p>If you have a class that feels like it:</p>
<ul>
<li>Contains hidden interactions that make you scratch your head.</li>
<li>Is difficult to read and retain in memory.</li>
<li>Is difficult to reason about its state or contains a bunch of conditional logic.</li>
<li>Is difficult to describe what it does or the word &lsquo;and&rsquo; is used.</li>
<li>Requires too many dependencies.</li>
<li>Requires too much work to write a test double.</li>
<li>Requires too many tests for full coverage.</li>
<li>Requires large tests with complex setup/teardown.</li>
</ul>
<p>Then, that class is likely violating the Single Responsibility Principle. Such classes hide points
of flexibility and encapsulate interaction instead of encapsulating behavior. Poor flexibility and
encapsulation creates brittle design and strong coupling. The result is a class that&rsquo;s hard to test.</p>
<h3 id="fixing-violations-3">Fixing violations</h3>
<p>Opportunity to fix a violation of the Single Responsibility Principle is either proactive or
reactive, depending on whether the violation is caught before or after it&rsquo;s committed to the
codebase.</p>
<p>It should go without saying that the proactive approach is less work.</p>
<h4 id="proactive">Proactive</h4>
<ol>
<li>Identify the individual responsibilities.</li>
<li>Give each responsibility a crisp name.</li>
<li>Extract functionality into each class.</li>
<li>Celebrate how much easier the class is to test.</li>
</ol>
<h4 id="reactive">Reactive</h4>
<ol>
<li>Extract a class in the place where behavior is being altered with new functionality.</li>
<li>Start to move chunks of behavior out of the legacy class and test each chunk in isolation.</li>
</ol>

<div class="notices tip" ><p><code>static</code> methods are a sign of a homeless method. It likely belongs to one of the parameters it
takes.</p>
</div>



<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/google-testing-blog/general/" title="General Notes"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/google-testing-blog/whittaker/" title="James Whittaker" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1582391604"></script>
    <script src="/js/perfect-scrollbar.min.js?1582391604"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1582391604"></script>
    <script src="/js/jquery.sticky.js?1582391604"></script>
    <script src="/js/featherlight.min.js?1582391604"></script>
    <script src="/js/highlight.pack.js?1582391604"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1582391604"></script>
    <script src="/js/learn.js?1582391604"></script>
    <script src="/js/hugo-learn.js?1582391604"></script>

    <link href="/mermaid/mermaid.css?1582391604" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1582391604"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

